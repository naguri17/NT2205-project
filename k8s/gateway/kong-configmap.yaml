---
apiVersion: v1
kind: ConfigMap
metadata:
    name: kong-config
    namespace: gateway
data:
    kong.yaml: |
        _format_version: "3.0"
        _transform: true

        plugins:
          # Expose /metrics for Prometheus scraping
          - name: prometheus

        services:
          # =========================================
          # PRODUCT SERVICE
          # =========================================
          - name: product-service
            url: http://product-service.backend.svc.cluster.local:8000/products
            routes:
              - name: product-route
                paths:
                  - /api/products
                strip_path: true
                methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                plugins:
                  - name: cors
                    config:
                      origins:
                        - http://localhost:3000
                        - http://localhost:3001
                        - http://app.lapisweb.online
                        - http://admin.lapisweb.online
                        - https://app.lapisweb.online
                        - https://admin.lapisweb.online
                      methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                      headers: [Authorization, Content-Type, Accept]
                      credentials: true
                      max_age: 3600
                  - name: rate-limiting
                    config:
                      minute: 100
                      policy: local

          # =========================================
          # CATEGORY SERVICE
          # =========================================
          - name: category-service
            url: http://product-service.backend.svc.cluster.local:8000/categories
            routes:
              - name: category-route
                paths:
                  - /api/categories
                strip_path: true
                methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                plugins:
                  - name: cors
                    config:
                      origins:
                        - http://localhost:3000
                        - http://localhost:3001
                        - http://app.lapisweb.online
                        - http://admin.lapisweb.online
                        - https://app.lapisweb.online
                        - https://admin.lapisweb.online
                      methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                      headers: [Authorization, Content-Type, Accept]
                      credentials: true
                      max_age: 3600
                  - name: rate-limiting
                    config:
                      minute: 100
                      policy: local

          # =========================================
          # ORDER SERVICE
          # =========================================
          - name: order-service
            url: http://order-service.backend.svc.cluster.local:8001
            routes:
              - name: order-route
                paths:
                  - /api/orders
                strip_path: true
                methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                plugins:
                  - name: cors
                    config:
                      origins:
                        - http://localhost:3000
                        - http://localhost:3001
                        - http://app.lapisweb.online
                        - http://admin.lapisweb.online
                        - https://app.lapisweb.online
                        - https://admin.lapisweb.online
                      methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                      headers: [Authorization, Content-Type, Accept]
                      credentials: true
                      max_age: 3600
                  - name: rate-limiting
                    config:
                      minute: 100
                      policy: local

          # =========================================
          # PAYMENT SERVICE
          # =========================================
          - name: payment-service
            url: http://payment-service.backend.svc.cluster.local:8002
            routes:
              - name: payment-route
                paths:
                  - /api/payments
                strip_path: true
                methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                plugins:
                  - name: cors
                    config:
                      origins:
                        - http://localhost:3000
                        - http://localhost:3001
                        - http://app.lapisweb.online
                        - http://admin.lapisweb.online
                        - https://app.lapisweb.online
                        - https://admin.lapisweb.online
                      methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                      headers: [Authorization, Content-Type, Accept]
                      credentials: true
                      max_age: 3600
                  - name: rate-limiting
                    config:
                      minute: 100
                      policy: local

          # =========================================
          # GATEWAY HEALTH CHECK
          # =========================================
          - name: gateway-health
            url: http://mockbin.org/request
            routes:
              - name: gateway-health-route
                paths:
                  - /health
                strip_path: true
                methods: [GET]
                plugins:
                  - name: cors
                    config:
                      origins: ["*"]
                      methods: [GET, OPTIONS]
                      headers: [Content-Type]
                      credentials: false

          # =========================================
          # KEYCLOAK (Optional - if proxying through Kong)
          # =========================================
          - name: keycloak
            url: http://keycloak.auth.svc.cluster.local:8080
            routes:
              - name: keycloak-route
                hosts:
                  - auth.lapisweb.online
                paths:
                  - /
                strip_path: false
                methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                plugins:
                  - name: cors
                    config:
                      origins: ["*"]
                      methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
                      headers:
                        - Authorization
                        - Content-Type
                        - Accept
                        - Origin
                        - X-Requested-With
                      credentials: true
                      max_age: 3600
